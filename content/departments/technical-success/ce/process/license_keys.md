# Customer License Key Management

This page explains how to create and maintain license keys for prospects and customers.

- [Licensing Overview](#licensing-overview)
  - [Accessing Site Admin](#accessing-site-admin)
  - [License Key Mechanics](#license-key-mechanics)
  - [Plans](#plans)
  - [License Key Tags](#feature-tags)
- [License Management Processes](#license-management-processes)
  - [Prospective Customer Trials](#prospective-customer-trials)
  - [Converting a Prospect to a New Customer](#converting-a-prospect-to-a-new-customer)
  - [Handling Renewals or Upgrades](#handling-renewals-or-upgrades)
  - [Reissuing an Expired License](#reissuing-expired-licenses)
- [Creating a new license walkthrough](create-new-license.md)
- [License Policies](#license-policies)
  - [License key sharing](#license-key-sharing-policy)
  - [Out of contract license extensions](#out-of-contract-license-extensions)
- [Internal FAQ](#internal-licensing-faq)

## Licensing Overview

Sourcegraph requires site administrators to apply a license key to access to various [paid features](https://sourcegraph.com/pricing). License keys are created and managed via the **Site-admin > Subscriptions** page on sourcegraph.com/search.

### Accessing Site Admin

License keys can only be generated by site administrators on sourcegraph.com. To create or maintain a license you must request temporary access via Entitle (in Okta). Entitle grants temporary access to site admin.

1. Go to Entitle via Okta
2. Search for `site admin` and select dotcom site admin access. Access is logged but automatically provisioned.
3. Log out of your sourcegraph.com/search account
4. Go [here](https://sourcegraph.com/sign-in?sourcegraph-operator) and select `other login methods`.
5. Click `Continue with Sourcegraph Operators`. You'll be signed in and taken to sourcegraph.com/search.
6. On the top right click on your profile icon and the `site admin` menu will now be available for you to access.
7. Go to `Subscriptions`.

### License Key Mechanics

We require a unique license for every discrete instance. Non-production instances are supported but require a separate key (more on this below).

A license is comprised of the following components, we'll go into each more in depth below:

- **User Account**: every license needs associated to a "user account". We create a company-level account for this.
- **Customer**: this auto-populates based on the user account created above.
- **Salesforce Subscription ID**: the ID of the active subscription (if relevant)
- **Salesforce Opportunity ID**: the ID from the active opportunity the license is associated with. For both the Opportunity ID and Subscription ID (if relevant) the correct IDs can be found on the `License IDs` field on the Opportunity. It's important to fill these in correctly for proper mapping and tracking.
- **Plan**: the [plan](#plans) dictates what features the license has access to.
- **Tags**: depending on the plan details you may need to add additional [feature tags](#feature-tags). Most commonly additional tags may be needed to allow for MAU plans or soft caps.
- **Users**: the count of users provisioned for this license.
- **Expires At**: the date at which the license expires.
  - NOTE: this expiration should match the contract, or in the case of a trial the agreed upon time frame of the trial.
  - NOTE: Licenses expire at midnight of the date selected based on _the timezone of the browser where the license is being generated from_. It is important to consider this as depending on the teammate location and the customer location you may need to actually set the expiration date to lag by a day.

#### Plans

Different plans have a unique featureset included with them. In some instances you can manually apply additional tags to include additional features (more on this below) but typically simply selecting the plan covers everything you'll need. Most frequently, CEs and TAs will be using the `enterprise-1` plan for all Enterprise customers.

Below is an overview of the **current supported plans** and included features:

<table>
  <tr>
   <td><strong>Plan Name</strong></td>
   <td><strong>Plan Tag</strong></td>
   <td><strong>Included Features</strong></td>
  </tr>
  <tr>
   <td>Enterprise</td>
   <td>enterprise-1</td>
   <td> ACLs (background permissions syncing), Explicit Permissions API (API access for setting repo permissions), SSO (allow non-builtin auth to be used), Private Repositories, SCIM (user management), Batch Changes (unlimited changesets), Code Monitors, Notebooks</td>
  </tr>
  <tr>
   <td>Enterprise (Airgapped)</td>
   <td>enterprise-air-gap-0</td>
   <td> Includes all of the same features as Enterprise-1 above but allows explicit ability to operate offline. Advanced approval required!</td>
  </tr>
    <tr>
   <td>Free</td>
   <td>free-1</td>
   <td> For new Free plan (from 4.5 onwards). We should not generate licenses with this plan. This is simply a fallback method.</td>
  </tr>
</table>

You can read more about legacy plans [below](#legacy-plans).

#### Feature Tags

As mentioned above our plans include a standard feature-set; however, you may need to manually add tags to include additional features. This sections provides an overview of current feature tags.

<table>
  <tr>
   <td><strong>Feature</strong></td>
   <td><strong>Tag</strong></td>
   <td><strong>Description</strong></td>
  </tr>
  <tr>
   <td>Hard cap</td>
   <td> </td>
   <td> Hard cap is our default; no tag is required. This means the user limit is a hard, capped limit.</td>
  </tr>
  <tr>
   <td>Soft Cap</td>
   <td>true-up</td>
   <td> Allows the customer to go over their user limit on the license (soft cap). When this tag appears on a license key, it overrides the default hard cap behavior and allows user counts to exceed the license.</td>
  </tr>
  <tr>
   <td>MAU Plan</td>
   <td>mau</td>
   <td> For companies on a monthly usage-based billing model. NOTE: For any MAU-based customers, the `true-up` tag must also be added as we do not have the ability to hard-cap MAU-based plans.</td>
  </tr>
  <tr>
   <td>Trial</td>
   <td>trial</td>
   <td> Indicates that this license key is for a trial instance.</td>
  </tr>
  <tr>
   <td>Development Environment</td>
   <td>dev</td>
   <td> Indicates that this license key is for a lower-level development environment. Does not affect contractual agreement; however, as a best practice, limit the seat count to 20 users.</td>
  </tr>
  <tr>
   <td>QA Environment</td>
   <td>qa</td>
   <td> Indicates that this license key is for a lower-level QA environment. Does not affect contractual agreement; however, as a best practice, limit the seat count to 20 users.</td>
  </tr>
  <tr>
   <td>Internal Environment</td>
   <td>internal</td>
   <td> Indicates that this license key is used for internal sites (dotcom, k8s, etc.) within Sourcegraph</td>
  </tr>
</table>

You can read more about legacy feature tags [below](#legacy-feature-tags).

#### Legacy Plans

You may come across legacy licenses associated to legacy plans. Previously no-longer-used, legacy plans you may encounter are:

<table>
  <tr>
   <td><strong>Plan Name</strong></td>
   <td><strong>Plan Tag</strong></td>
   <td><strong>Included Features</strong></td>
  </tr>
  <tr>
   <td>Enterprise Starter (legacy)</td>
   <td>old-starter-0</td>
   <td> This is a legacy tag that was used for "Enterprise Starter" plans.</td>
  </tr>
  <tr>
   <td>Enterprise (legacy)</td>
   <td>old-enterprise-0</td>
   <td> This is a legacy tag that was used for Enterprise plans.</td>
  </tr>
  <tr>
   <td>Team (legacy)</td>
   <td>team-0</td>
   <td> Until 4.0 this was used for customers on a deprecated Team plan. </td>
  </tr>
  <tr>
   <td>Enterprise (legacy)</td>
   <td>enterprise-0</td>
   <td> Until 4.0 used for our legacy Enterprise pricing plan; required each feature to be tagged separately.</td>
  </tr>
  <tr>
   <td>Business (legacy)</td>
   <td>business-0</td>
   <td> In our 4.0 release this was used for a legacy business plan that's no longer active.</td>
  </tr>
  <tr>
   <td>Enterprise Extension (legacy)</td>
   <td>enterprise-extension</td>
   <td> In 4.4.2 release some customers required an extended trial. This was used for those situations but is no longer active.</td>
  </tr>
  <tr>
   <td>Free (legacy)</td>
   <td>free-0</td>
   <td> For legacy Free plan (until 4.5) customers, for which we need to generate a license to keep them using the existing feature set </td>
  </tr>
</table>

#### Legacy feature tags

Below are old, legacy feature tags that you may encounter. These are now handled at the plan level.

<table>
  <tr>
   <td><strong>Legacy Feature</strong></td>
   <td><strong>Legacy Tag</strong></td>
   <td><strong>Description</strong></td>
  </tr>
  <tr>
    <td> Airgapped </td>
    <td> allow-air-gapped </td>
    <td> For licenses where periodic license verification is not required and pings are not sent back to sourcegraph.com. This is essential for customers that run Sourcegraph in an air-gapped environment without an external internet connection. NOTE: This is included in the `enterprise-air-gap-0` plan. , this tag is not required as it is included in the plan. Prefer selecting the `enterprise-air-gap-0` plan instead of adding the tag. </td>
  </tr>
  <tr>
    <td> PLG Cloud Trial </td>
    <td> plg-trial </td>
    <td> Previously we allowed users to sign up for a free trial of Sourcegraph via signup.sourcegraph.com. This is deprecated. </td>
  </tr>
    <td>Monitoring</td>
    <td>monitoring</td>
    <td>Added support for running Grafana monitoring. **DEPRECATED as of Sourcegraph 5.0** </td>
  </tr>
  <tr>
   <td>ACLS</td>
   <td>acls</td>
   <td> For background permissions syncing from the code host (now included on plans by default).</td>
  </tr>
     <td>Batch Changes</td>
    <td>batch-changes</td>
    <td> For unlimited access to the batch changes (now included on plans by default).</td>
  </tr>
  </tr>
    <td>Code Insights</td>
    <td>code-insights</td>
    <td> For unlimited access to the code insights (now included on plans by default).</td>
  </tr>
  </tr>
    <td>Private Extension Registry</td>
    <td>private-extension-registry</td>
    <td> Allows for a private Extension registry (now included on plans by default).</td>
  </tr>
  </tr>
    <td>Remote Extensions</td>
    <td>remote-extensions-allow-disallow</td>
    <td> Allows the admin to enable / disable remote extensions (now included on plans by default).</td>
  </tr>
  </table>

## License Management Processes

### Prospective Customer Trials

For a new Sales-led trial, you'll need to create a _new_ subscription that will be used only for the trial period. (Follow the instructions for [issuing a new license](create-new-license.md) from start to finish.).

A note on Sales-led cloud (managed instance) trials: as part of the [Managed Instance creation process](../../../cloud/trial_mi.md#trial-managed-instance-creation-flow-manual), the CE should create a license key for the new instance and submit it with the GH issue request.

### Converting a Prospect to a New Customer

When a prospect converts to a customer, you will need to create a _new_ subscription; **do not** reuse the trial subscription. Follow the instructions for [issuing a new license](create-new-license.md) from start to finish. This is to ensure data accuracy for the Sales Ops team. Importantly, the Opportunity ID, Subscription ID and expiration need to match what's in Salesforce and the contract.

### Handling renewals or upgrades

If an existing company or customer needs a new license key for any reason (e.g., they purchase more seats, they upgrade product tiers, or they simply renew), the TA will add a new license key to the _existing_ subscription. In that circumstance, do not click **Create a product subscription**; find the existing subscription on that page and then once viewing it, click **Generate new license manually**.

Visit the **Site-admin > Subscriptions** page, find the existing subscription, click into it, and follow the steps below (from the "Click **Generate new license manually**" step onwards).

1. Sign in to sourcegraph.com and visit the **Site-admin > Subscriptions** page.
2. Search for the user associated with the company, and click into the existing subscription ID (left-most column). (You can also check for a user already exists following the instructions in the [Internal Licensing FAQ](#internal-licensing-FAQ) document.)
3. Click **Generate new license manually**. Fill out the license end date (most typically to match the contract terms) and fill in the appropriate license tags. For tags, see [License Key Tags](#license-key-tags) section. Tags must be separated by comma (spaces are ignored).
4. Set the licensed number of users (note that if you added the `true-up` tag, the company will be able to exceed this count, but administrators will see a warning) and the end date for which the license should be valid, and click **Generate license**.
5. Finally, copy the license key, and send it to the relevant contact at the company. You can link them to the following docs for instructions on where to add the key: [Updating your license key](https://docs.sourcegraph.com/admin/subscriptions#updating-your-license-key)

## Reissuing Expired Licenses

In most circumstances, license keys match the renewal dates on an account contract and are generated well ahead of time. Sometimes, license keys deviate from this format due to product trials and other special circumstances. If a license key is imminently expiring or has expired, follow these steps:

1. Check with the account's Technical Advisor & Account Executive, as well as the Salesforce Account record and the account running notes. This will help you understand any special context surrounding the current license key tags and expiration dates.
2. Grab the contract end date by going to the Account page in Salesforce to look up the `"Active Contract Period End"`.
3. Follow the process below for generating a renewal license key. Unless otherwise noted during Step 1, use the same exact tags and user count as the existing key (make sure to comma separate each tag) and use the `"Active Contract Period End"` as the expiration date.
4. Send the new license key to the customer (follow the process outlined below).

### Revoking an active license

In extreme circumstances, it may be required to revoke a customer's active Sourcegraph license. This will mark the license as invalid on Sourcegraph.com, and license verification checks from the customer's Sourcegraph instance will fail, ultimately disabling all Sourcegraph Enterprise features.

To revoke an active license, follow these steps:

1. Sign in to sourcegraph.com and visit the **Site-admin > Subscriptions** page.
2. Navigate to the license that needs to be revoked.
3. Click on the red **Revoke** button and provide a reason for the revocation.

The next time the customer's instance performs a license verification check, the verification will fail and the customer's Enterprise features will be disabled.

> [!NOTE] This will not work on special licenses with the `enterprise-air-gap-0` plan, as these licenses do not execute verification checks.

## License Policies

### License Key Sharing Policy

Within Sourcegraph we use 1Password for managing our credentials, including license keys. Follow these steps for safely sharing licensing credentials with customers.

1. Create a new record in your private Vault (type = software license).
2. Name the entry the customers' name, enter the license key, and enter the admin's email address. Click Save.
3. Go to the newly created record and click Share. A prompt will be displayed with sharing options. Set the link to expire after 7 days, make it available only to some people, check the box for "Can be viewed only 1 time per person", and enter the admin's email address. Click Get Link to Share.
4. Copy the private link that is generated and send to the admin. (Note: they must verify their email address to access the link).

### Out of Contract License Extensions

In select circumstances, such as a bridge extension being requested due to the renewal process not aligning with license expiration, Sales **must receive approval from the VP of Finance and VP of Sales to issue a licensing exception**. This approval is granted via request in #deal-desk. If an AE requests a deviation from their contract licensing terms, please validate that the necessary approvals have been granted _before_ making any changes to a customer's license key.

## Internal licensing FAQ

In case you have a question regarding licensing that is not discussed on this page, check if it is answered in the [internal licensing FAQ](https://docs.google.com/document/d/1xzlkJd3HXGLzB67N7o-9T1s1YXhc1LeGDdJyKDyqfbI). Or direct questions to the #licenses channel in slack.
